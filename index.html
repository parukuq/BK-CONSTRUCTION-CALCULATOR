<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BK Construction Calculator</title>

<style>
body {font-family: Arial; background:#f5f5f5; padding:15px;}
.header {display:flex; justify-content:space-between; align-items:center;}

textarea {
padding:5px;
margin:3px;
width:180px;
height:80px;
font-size:18px;
}

.section {background:white; padding:10px; margin:10px 0; border-radius:10px;}
.row {display:flex; gap:10px; margin-bottom:5px; align-items:flex-start;}
button {padding:5px; margin-top:5px;}
.output {white-space:pre-line; font-weight:bold;}

.keypad {
position:fixed;
bottom:0;
left:0;
right:0;
background:#000;
display:none;
grid-template-columns:repeat(4,1fr);
gap:5px;
padding:10px;
z-index:999;
}

.keypad button {
font-size:20px;
padding:15px;
background:#444;
color:white;
border:none;
border-radius:8px;
}

.op {background:#ff9500;}
.ctrl {background:#666;}
.done {background:#34c759;}
</style>
</head>

<body onclick="closeKeypad(event)">

<div class="header">
<h2>BK Construction Calculator</h2>
<div>
<input type="text" id="name" placeholder="Enter Name"><br>
<span id="date"></span>
</div>
</div>

<div id="sections"></div>

<h3>
Total:
<span id="grandTotal">0</span>
*
<input type="number" id="multiplier" placeholder="Multiplier" onfocus="hideKeypad()" oninput="finalCalc()" style="width:80px;">
=
<span id="finalTotal">0</span>
</h3>

<button id="saveBtn" onclick="saveImage()">Save Screenshot</button>

<div id="keypad" class="keypad"></div>

<script>

let activeInput=null;

const keys = ["7","8","9","⌫",
              "4","5","6","*",
              "1","2","3",".",
              "↓","0","Done"];

function showKeypad(input){
activeInput=input;
document.getElementById("keypad").style.display="grid";
renderKeys();
}

function hideKeypad(){
document.getElementById("keypad").style.display="none";
activeInput=null;
}

function closeKeypad(e){
if(!e.target.classList.contains("multiInput")){
hideKeypad();
}
}

function renderKeys(){
let pad=document.getElementById("keypad");
pad.innerHTML="";

keys.forEach(k=>{
let b=document.createElement("button");
b.innerText=k;

if(k=="*" ) b.classList.add("op");
if(k=="⌫" || k=="↓") b.classList.add("ctrl");
if(k=="Done") b.classList.add("done");

b.onclick=function(e){
e.stopPropagation();

if(!activeInput) return;

if(k=="⌫"){
activeInput.value = activeInput.value.slice(0,-1);
}
else if(k=="↓"){
hideKeypad();
return;
}
else if(k=="Done"){
calc();
hideKeypad();
return;
}
else{
activeInput.value += k;
}

calc();
};

pad.appendChild(b);
});
}

// BEAM removed
const sections = [
{name:"SLAB", id:"SLAB"},
{name:"PILLARS", id:"PILLARS"},
{name:"FOOTING", id:"FOOTING"},
{name:"F.BEAM", id:"FBEAM"},
{name:"STEPS", id:"STEPS"},
{name:"TANK", id:"TANK"},
{name:"S.BEAM", id:"SBEAM"}
];

document.getElementById("date").innerText = new Date().toLocaleDateString();

function createSection(sec){
let div=document.createElement("div");
div.className="section";

div.innerHTML=`
<h3>${sec.name}</h3>
<div id="${sec.id}"></div>
<button onclick="addRow('${sec.id}')">+ Add Row</button>
<button onclick="clearSection('${sec.id}')">Clear Section</button>
<p>Total: <span id="${sec.id}_total">0</span></p>`;

document.getElementById("sections").appendChild(div);
addRow(sec.id);
}

function addRow(id){
let row=document.createElement("div");
row.className="row";

let textarea=document.createElement("textarea");
textarea.className="multiInput";
textarea.placeholder="Tap to enter";
textarea.readOnly=true;
textarea.onclick=function(e){
e.stopPropagation();
showKeypad(textarea);
};

let output=document.createElement("div");
output.className="output";

row.appendChild(textarea);
row.appendChild(output);

document.getElementById(id).appendChild(row);
}

function clearSection(id){
let rows=document.querySelectorAll('#'+id+' .multiInput');
rows.forEach(r=>r.value="");
calc();
}

function calc(){
let grand=0;

sections.forEach(sec=>{
let rows=document.querySelectorAll('#'+sec.id+' .row');
let total=0;

rows.forEach(r=>{
let text=r.querySelector(".multiInput").value;
let outputBox=r.querySelector(".output");

let sum=0;
let resultText="";

let lines=text.split("\n");

lines.forEach(line=>{
line=line.trim();
line=line.replace(/×/g,"*").replace(/X/g,"*");

if(line.includes("*")){
let parts=line.split("*");

let result=1;
let valid=true;

parts.forEach(p=>{
let num=parseFloat(p);
if(isNaN(num)){
valid=false;
}else{
result *= num;
}
});

if(valid){
sum+=result;
resultText += line+" = "+result+"\n";
}
}
});

outputBox.innerText=resultText;
total+=sum;
});

document.getElementById(sec.id+"_total").innerText=total.toFixed(2);
grand+=total;
});

document.getElementById("grandTotal").innerText=grand.toFixed(2);
finalCalc();
}

function finalCalc(){
let g=parseFloat(document.getElementById("grandTotal").innerText)||0;
let m=parseFloat(document.getElementById("multiplier").value)||0;
document.getElementById("finalTotal").innerText=(g*m).toFixed(2);
}

sections.forEach(createSection);

function saveImage(){
hideKeypad();
document.getElementById("saveBtn").style.display="none";

html2canvas(document.body).then(canvas=>{
let link=document.createElement('a');
link.download='BK_Calculation.png';
link.href=canvas.toDataURL();
link.click();

location.reload();
});
}

</script>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>
